<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>%reportName% - kbn-alert-load report</title>
  <link rel="shortcut icon" href="https://elastic.co/favicon.ico" type="image/x-icon">
  <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
  <!--
  <script src="https://cdn.jsdelivr.net/npm/vega@5/build/vega.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@4/build/vega-lite.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6/build/vega-embed.js"></script>
  -->
  
  <style>
    td {
      padding-top: 0;
      padding-bottom: 0;
    }
    h3, h4, table {
      margin: 0.5em 0;
    }
    .viz {
      width: 50%;
      padding: 1em 2em;
    }
    .indent {
      margin-left: 2em;
    }

    .container {
      padding: 16px;
    }

    .flex {
      display:  flex;;
    }

    .flex-grow-1 {
      flex-grow: 1;;
    }

    .rules-status {
      font-size: 18px;
    }

    .red {
      color: #e74c3c;
    }

    .green {
      color: #27ae60;
    }

    .info {
      font-size: 20px;
    }

    .info div {
      margin-right: 16px;
    }

  </style>
</head>

<body>
  <h1>%reportName% - kbn-alert-load report</h1>

  <table width="100%">
    <tr>
      <td valign="top">
        <h3>load test results for Kibana alerting</h3>
        <table>
          <tr><td>suite:</td><td id='var-description'></td></tr>
          <tr><td>date:</td><td>%date%</td></tr>
          <tr><td>zone:</td><td>%zone%</td></tr>
          <tr><td>suite id:</td><td id='var-suite'></td></tr>
        </table>
      </td>
      <td valign="top">
        <h3>common scenario settings</h3>
        <table id='table-shared-settings'></table>
      </td>
    </tr>
  </table>
  
  <div class="container" id="rules"></div>



  <p><i>generated by <a href='https://github.com/pmuellr/kbn-alert-load'>kbn-alert-load</a></i></p>
</body>


<script type="module">
  import { h, Component, render } from 'https://unpkg.com/preact?module';
  import htm from 'https://unpkg.com/htm?module';
  // sort array ascending


  const { eventLog, kbStatus, KbTaskManager, esStatus, suite, deployments, ruleStatus } = getAllData()
  const chartWidth = 200;
  const colors = [
    '#00BFB3',
    '#F04E98',
    '#1BA9F5',
    '#0077CC',
  ]
  document.getElementById('var-suite').innerHTML = suite.id
  document.getElementById('var-description').innerHTML = suite.description
  document.getElementById('table-shared-settings').innerHTML = getSharedSettings()
 
  // Initialize htm with Preact
  const html = htm.bind(h);


  const scenarios = Object.keys(ruleStatus);
  const rulesData = scenarios.map((scanarioName) => {
    const rulesInfo = Object.entries(ruleStatus[scanarioName]).map(
      ([ruleId, ruleInfo]) => {
          const events = eventLog.filter(event => event.ruleId === ruleId)
          return {
            ruleId,
            ...ruleInfo,
            bulk_create_time_durations: ruleInfo.current_status.bulk_create_time_durations[0],
            search_after_time_durations: ruleInfo.current_status.search_after_time_durations[0],
            duration: events[events.length - 1].duration
          }
      }
    );
    return rulesInfo;
  })[0];

  const rulesCount = rulesData.length
  const succeededRulesCount = rulesData.filter(rule => rule.current_status.status === 'succeeded' || (rule.current_status.status === 'going to run' && rule.current_status.last_success_message === 'succeeded')).length;
  const successRate = Number((succeededRulesCount / rulesCount) *  100).toFixed(2)

  const earliestDate = Date.parse(eventLog[0].date)
  // augment the eventLog
  eventLog.forEach(event => {
    event.dateNumber = Date.parse(event.date)
    event.dateRelative = event.dateNumber - earliestDate
    event.minute = event.dateRelative / 1000 / 60
  })

  const executionTimes = eventLog.map(info => info.duration)
  
  const { sameVals } = getScenarioSameAndDiffProps()

  function App (props) {
    return html`
     <div>
        <div class="flex info">
          <div> Rules count: <b>${sameVals.get("alerts")} </b></div>
          <div> Events: <b>${sameVals.get("indicatorCount")}  </b></div>
          <div> Rule interval: <b>${sameVals.get("alertInterval")}  </b></div>
          <div> Indicator index size: <b>${sameVals.get("indicatorIndexSize")} </b> </div>   
        </div>
        <div class="rules-status">
          <h3>Execution status (last run)</h3>
          <div>Rules count: ${rulesCount} </div>
          <div>Sucess rate: ${successRate} % </div>
          <div class="green">Succeded rules: ${succeededRulesCount} / ${rulesCount}</div>
          <div class="red">Failed rules: ${rulesCount - succeededRulesCount} / ${rulesCount}</div>
        </div>
        <div class="flex">
          <div class="flex-grow-1">
            <h3>Rule Execution Time (total)</h3>
            <div>
              <p>p50: ${percentile(executionTimes, .50)}ms</p>
              <p>p90: ${percentile(executionTimes, .90)}ms</p>
            </div>
          </div>
  
        </div>
        <div class="flex">
          <div class="flex-grow-1" id="rulesExecutionTime"></div>
          <div class="flex-grow-1" id="vis-execution-time"></div>
        </div>
      </div>`;
  }

  render(html`<${App}  />`, document.querySelector('#rules'));
  

  const createHistogram = ({
    id,
    data,
    xField,
    xTitle
  }) => {
    vegaEmbed(id, {
      $schema: 'https://vega.github.io/schema/vega-lite/v5.json',
      "data": {values: data},
      "height": 200,
      "transform": [{
          "bin": true, "field": xField, "as": "bin_A"
        }, {
          "aggregate": [{"op": "count", "as": "Count"}],
          "groupby": ["bin_A", "bin_A_end"]
        }, {
          "joinaggregate": [{"op": "sum", "field": "Count", "as": "TotalCount"}]
        }
      ],
      "mark": {"type": "bar", "tooltip": true},
      "encoding": {
        "x": {
          "title": xTitle,
          "field": "bin_A",
          "bin": {"binned": true}
        },
        "x2": {"field": "bin_A_end"},
        "y": {
          "title": "Rules count",
          "field": "Count",
          "type": "quantitative"
        }
      }
    })
  }


  
  createHistogram({
    id: '#rulesExecutionTime',
    xField: 'duration',
    xTitle: 'Execution time (ms)',
    data: eventLog
  })



  vegaEmbed('#vis-execution-time', {
    $schema: 'https://vega.github.io/schema/vega-lite/v4.json',
    width: chartWidth,
    mark: { 
      type: 'point', 
      size: 100,
      strokeWidth: 1,
      opacity: 0.7,
      color: colors[0],
      tooltip: true
    },
    encoding: {
      x: {
        title: 'minutes since start',
        field: 'dateRelative',
        type: 'temporal',
        axis: {
          format: '%-M',
          formatType: 'time',
          tickCount: 'minute',
        }
      },
      y: {
        title: 'execution time (milliseconds)',
        field: 'duration',
        type: 'quantitative',
        scale: { zero: true, type: 'log' },
        axis: { grid: false }
      }
    },
    data: { values: eventLog }
  })
  


  function percentile(arr, q) {
    const asc = arr => arr.sort((a, b) => a - b);

    const sum = arr => arr.reduce((a, b) => a + b, 0);

    const mean = arr => sum(arr) / arr.length;

    // sample standard deviation
    const std = (arr) => {
        const mu = mean(arr);
        const diffArr = arr.map(a => (a - mu) ** 2);
        return Math.sqrt(sum(diffArr) / (arr.length - 1));
    };

      const sorted = asc(arr).map(Number);
      const pos = (sorted.length - 1) * q;
      const base = Math.floor(pos);
      const rest = pos - base;
      if (sorted[base + 1] !== undefined) {
          return Number(sorted[base] + rest * (sorted[base + 1] - sorted[base])).toFixed(2);
      } else {
          return  Number(sorted[base]).toFixed(2);
      }
  }
  
  function getSharedSettings() {
    const { sameVals } = getScenarioSameAndDiffProps()

    const result = []
    for (const key of Array.from(sameVals.keys()).sort()) {
      result.push(`<tr><td>${key}:</td><td align="right">${sameVals.get(key)}</td></tr`)
    }

    return result.join('\n')
  }


  function getScenarioSetttings() {
    const { sameVals, diffVals } = getScenarioSameAndDiffProps()

    const result = []
    for (const deployment of deployments) {
      result.push(`<h4>${deployment.scenario.sortName}</h4>`)
      result.push('<div class="indent">')
      result.push(`<table>`)
      for (const key of Array.from(diffVals.keys()).sort()) {
        result.push(`<tr><td>${key}:</td><td align="right">${deployment.scenario[key]}</td></tr>`)
      }
      result.push('</table>')
      result.push('</div>')
    }

    return result.join('\n')
  }

  function getScenarioPropsAndNames() {
    /** @type { Set<string> } */
    const allProps = new Set()
    /** @type { string[] } */
    const names = []
    for (const deployment of deployments) {
      const scenario = deployment.scenario
      for (const key of Object.keys(scenario)) {
        if (key === 'name') {
          names.push(scenario.name)
        } else if (key !== 'sortName') {
          allProps.add(key)
        }
      }
    }

    return {
      names,
      props: Array.from(allProps.values()).sort()
    }
  }

  function getScenarioSameAndDiffProps() {
    const { props } = getScenarioPropsAndNames()

    /** @type { Map<string, any> } */
    const sameVals = new Map()
    /** @type { Set<string> } */
    const diffVals = new Set()

    for (const deployment of deployments) {
      const scenario = deployment.scenario
      for (const prop of props) {
        if (!sameVals.has(prop)) {
          sameVals.set(prop, scenario[prop])
        } else {
          if (sameVals.get(prop) !== scenario[prop]) {
            diffVals.add(prop)
          }
        }
      }
    }

    for (const diffValKey of diffVals) {
      sameVals.delete(diffValKey)
    }

    return {
      sameVals,
      diffVals,
    }
  }

  function getAllData() {
    const data = 
    // data-start
    {
      /** @type { any } */
      suite: "%Suite%",
      /** @type { any[] } */
      deployments: ["%Deployments%"],
      /** @type { any[] } */
      eventLog: ["%EventLog%"],
      /** @type { any[] } */
      kbStatus: ["%KbStatus%"],
      /** @type { Record<string, any[]> } */
      KbTaskManager: ["%KbTaskManager%"],
      /** @type { any[] } */
      esStatus: ["%EsStatus%"],
      /** @type { any[] } */
      ruleStatus: ["%RuleStatus%"],
    }
    // data-end

    return data
  }
</script>

</html>
